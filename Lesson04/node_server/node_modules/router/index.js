var url = require("url");
var route_handler = require("route_handler");
var p = require('path');

var route = {
	allowedExt: ['.css','.js', '.hmtl', '.htm', 'png','jpg','.gif','jpeg'],
	showHead: function(code) {
		this.response.writeHead(code,{"Content-Type":"text/html"})
	},
	write: function(data) {
		this.response.write(data);
	},
	end: function(){
		this.response.end();
	},
	init: function(request,response){
		this.request = request;
		this.response = response;
		this.route();
	},
	route: function(){

		var path = url.parse(this.request.url);

		var controller = path.pathname.replace(/\//g,"");
		var parse_url = p.parse(path.pathname);
		if (parse_url.ext) {
			//если разршенный файл
			var allowed = this.allowedExt.indexOf(parse_url.ext);
			if (allowed>=0) {
				/*передаем в хандлер*/
				route_handler.showFile(path.pathname,this);
				return;
			}
		}

		

		//ссылка на текущи обект
		var self = this;

		var result = function(res) {
			console.log(res);
		}

		if (!controller) controller = 'index';
		if (typeof route_handler[controller] != 'function') return this.error(404);
		this.showHead(200);
		route_handler[controller](result, this);
	},
	error:function(code){
		this.showHead(code);
		this.write("<h1>Sorry error " + code+";( </h1>");
		this.end();
		return;
	}
}

module.exports.route = route;
